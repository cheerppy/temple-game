<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±šå°å±‹æ¢æ¤œéšŠ - è±šå°å±‹ã«å…¥ã‚‰ãšã‚“ã°å­è±šã‚’å¾—ãš</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #04384c 0%, #022838 50%, #011825 100%);
            color: #e8f4f8; 
            min-height: 100vh; 
            padding: 10px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 0, 0, 0.7); border-radius: 15px; }
        .header h1 { color: #FFD700; font-size: 2em; margin-bottom: 8px; }
        .subtitle { color: #DC143C; font-style: italic; }
        .connection-status, .player-name-display { position: fixed; top: 10px; padding: 8px 15px; border-radius: 15px; font-weight: bold; z-index: 100; font-size: 12px; }
        .connection-status { right: 10px; background: rgba(220, 20, 60, 0.9); color: white; }
        .connection-status.connected { background: rgba(34, 139, 34, 0.9); }
        .player-name-display { left: 10px; background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; display: none; }
        .error-message { background: rgba(220, 20, 60, 0.9); color: white; padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; }
        .btn { background: linear-gradient(45deg, #04384c, #065a7a); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; }
        .btn:hover { background: linear-gradient(45deg, #065a7a, #0876a0); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #87CEEB; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #04384c; border-radius: 5px; background: rgba(0, 0, 0, 0.7); color: #e8f4f8; font-size: 16px; }
        .control-section { background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 10px; border: 2px solid rgba(135, 206, 235, 0.2); margin-bottom: 15px; }
        .control-section h3 { color: #87CEEB; margin-bottom: 15px; }
        #lobby, #room-info, #game-board, #victory-screen { display: none; }
        #lobby { display: block; }
        .room-id-display { background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-size: 1.5em; font-weight: bold; border: 2px solid rgba(255, 215, 0, 0.5); }
        .players-list { background: rgba(4, 56, 76, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .player-item { padding: 10px; margin: 6px 0; background: rgba(0, 0, 0, 0.5); border-radius: 5px; }
        .game-info { background: rgba(4, 56, 76, 0.5); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .my-cards-section { background: rgba(4, 56, 76, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .my-cards-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .card { aspect-ratio: 3/4; border: 2px solid #04384c; border-radius: 8px; background: linear-gradient(135deg, #022838, #04384c); display: flex; align-items: center; justify-content: center; font-weight: bold; min-height: 60px; }
        .other-players-container { margin-bottom: 15px; }
        .other-player-box { background: rgba(0, 0, 0, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(135, 206, 235, 0.2); }
        .other-player-cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .other-card { aspect-ratio: 3/4; border: 2px solid #04384c; border-radius: 6px; background: linear-gradient(135deg, #011825, #04384c); cursor: pointer; min-height: 45px; }
        .victory-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .victory-content { background: linear-gradient(135deg, #04384c, #022838); padding: 30px; border-radius: 20px; text-align: center; border: 3px solid #FFD700; max-width: 400px; width: 100%; }
        .checkbox-group { margin-bottom: 15px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .status-success { background: rgba(34, 139, 34, 0.9) !important; }
        .status-warning { background: rgba(255, 165, 0, 0.9) !important; }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">ğŸ”´ æœªæ¥ç¶š</div>
    <div class="player-name-display" id="player-name-display">ğŸ‘¤ <span id="my-name"></span></div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ· è±šå°å±‹æ¢æ¤œéšŠ ğŸ·</h1>
            <p class="subtitle">è±šå°å±‹ã«å…¥ã‚‰ãšã‚“ã°å­è±šã‚’å¾—ãš</p>
        </div>

        <div id="error-message" class="error-message"></div>

        <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
        <div id="lobby" class="lobby">
            <div class="control-section">
                <h3>æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
                <div class="input-group">
                    <label for="player-name-create">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="player-name-create" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="use-password">
                    <label for="use-password" style="display: inline;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹</label>
                </div>
                <div class="input-group" id="password-group" style="display: none;">
                    <label for="room-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="room-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <button id="create-room" class="btn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
            </div>
            
            <div class="control-section">
                <h3>ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
                <div class="input-group">
                    <label for="player-name-join">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="player-name-join" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="room-id-input">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="room-id-input" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <div class="input-group" id="join-password-group" style="display: none;">
                    <label for="join-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="join-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <button id="join-room" class="btn">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
            </div>

            <div class="control-section">
                <h3>ã‚²ãƒ¼ãƒ ä¸­ã®ãƒ«ãƒ¼ãƒ ã«å†å…¥å ´</h3>
                <div class="input-group">
                    <label for="rejoin-player-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="rejoin-player-name" placeholder="å…ƒã®åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="rejoin-room-id">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="rejoin-room-id" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <button id="rejoin-room" class="btn">ã‚²ãƒ¼ãƒ ã«å†å…¥å ´</button>
            </div>

            <div class="control-section">
                <h3>è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="input-group">
                    <label for="spectator-name">è¦³æˆ¦è€…å:</label>
                    <input type="text" id="spectator-name" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="spectate-room-id">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="spectate-room-id" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <button id="spectate-room" class="btn">è¦³æˆ¦ã™ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ æƒ…å ±ç”»é¢ -->
        <div id="room-info" class="room-info">
            <div class="room-id-display">ãƒ«ãƒ¼ãƒ ID: <span id="room-id-display"></span></div>
            
            <div class="players-list">
                <h3>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (<span id="player-count">0</span>/10)</h3>
                <div id="players-list"></div>
            </div>
            
            <div>
                <button id="start-game" class="btn" style="display: none;">ã‚²ãƒ¼ãƒ é–‹å§‹ (3äººä»¥ä¸Šå¿…è¦)</button>
                <button id="leave-room" class="btn">ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
                <button id="temp-leave-room" class="btn" style="display: none;">ä¸€æ™‚é€€å‡º</button>
                <button id="cancel-temp-leave" class="btn" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>

            <div class="temp-leave-section" id="temp-leave-section" style="display: none;">
                <h4>âš ï¸ ã‚²ãƒ¼ãƒ ä¸­ã®ä¸€æ™‚é€€å‡º</h4>
                <p>ã‚²ãƒ¼ãƒ ä¸­ã§ã™ãŒã€ä¸€æ™‚çš„ã«é€€å‡ºã§ãã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-board" class="game-board">
            <div class="game-info">
                <h3>ã‚²ãƒ¼ãƒ æƒ…å ±</h3>
                <p>ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="current-round">1</span>/4</p>
                <p>è²¡å®: <span id="treasure-found">0</span>/<span id="treasure-goal">7</span></p>
                <p>ç½ : <span id="trap-triggered">0</span>/<span id="trap-goal">2</span></p>
                <p>éµä¿æŒè€…: <span id="key-holder-name">ä¸æ˜</span></p>
                <p id="turn-message">å¾…æ©Ÿä¸­...</p>
            </div>

            <div class="my-cards-section">
                <h3>ã‚ãªãŸã®ã‚«ãƒ¼ãƒ‰</h3>
                <p>å­è±š <span id="my-treasure">0</span> / ç½  <span id="my-trap">0</span> / ç©ºã <span id="my-empty">0</span></p>
                <div id="my-cards-grid" class="my-cards-grid"></div>
            </div>

            <div>
                <h3>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                <div id="other-players-container" class="other-players-container"></div>
            </div>

            <button id="game-leave-room" class="btn">ä¸€æ™‚é€€å‡º</button>
            <button id="return-to-lobby" class="btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>

        <!-- å‹åˆ©ç”»é¢ -->
        <div id="victory-screen" class="victory-screen">
            <div class="victory-content">
                <h2 id="victory-title"></h2>
                <p id="victory-message"></p>
                <div id="winners-list"></div>
                <button id="return-to-lobby-victory" class="btn">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å¿…è¦ãªéš ã—è¦ç´  -->
    <div id="treasure-icons" style="display: none;"></div>
    <div id="trap-icons" style="display: none;"></div>
    <div id="game-room-id" style="display: none;"><span id="game-room-id-text"></span></div>
    <div id="role-reveal" style="display: none;">
        <div id="player-role"></div>
        <p id="role-description"></p>
        <img id="role-image" src="" alt="">
    </div>

    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <script>
        // å®Œå…¨çµ±åˆç‰ˆJavaScript
        console.log('çµ±åˆJavaScripté–‹å§‹');

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const safeGetElement = (id) => document.getElementById(id);
        const safeSetText = (id, text) => {
            const el = safeGetElement(id);
            if (el) el.textContent = text;
        };
        const safeSetHTML = (id, html) => {
            const el = safeGetElement(id);
            if (el) el.innerHTML = html;
        };
        const safeAddEventListener = (id, event, handler) => {
            const element = safeGetElement(id);
            if (element) {
                element.addEventListener(event, handler);
                console.log(`âœ… ${id} ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ æˆåŠŸ`);
            } else {
                console.warn(`âš ï¸ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #${id}`);
            }
        };

        // UIManager ã‚¯ãƒ©ã‚¹
        class UIManager {
            static showError(message, type = 'error') {
                const errorEl = safeGetElement('error-message');
                if (!errorEl) return;
                
                errorEl.textContent = message;
                errorEl.className = 'error-message';
                
                if (type === 'success') {
                    errorEl.classList.add('status-success');
                } else if (type === 'warning') {
                    errorEl.classList.add('status-warning');
                }
                
                errorEl.style.display = 'block';
                
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, type === 'success' ? 3000 : 5000);
            }

            static showConnectionStatus(status) {
                const statusEl = safeGetElement('connection-status');
                if (!statusEl) return;
                
                if (status === 'connected') {
                    statusEl.textContent = 'ğŸŸ¢ æ¥ç¶šæ¸ˆã¿';
                    statusEl.className = 'connection-status connected';
                } else {
                    statusEl.textContent = 'ğŸ”´ åˆ‡æ–­';
                    statusEl.className = 'connection-status disconnected';
                }
            }

            static showPlayerName(name) {
                const displayEl = safeGetElement('player-name-display');
                const nameEl = safeGetElement('my-name');
                
                if (displayEl && nameEl) {
                    displayEl.style.display = 'block';
                    nameEl.textContent = name;
                }
            }

            static showScreen(screenName) {
                const screens = ['lobby', 'room-info', 'game-board', 'victory-screen'];
                
                screens.forEach(screen => {
                    const element = safeGetElement(screen);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                if (screenName) {
                    const screen = safeGetElement(screenName);
                    if (screen) {
                        screen.style.display = 'block';
                    }
                }
            }

            static updatePlayersList(players, hostId) {
                const container = safeGetElement('players-list');
                const countEl = safeGetElement('player-count');
                
                if (!container || !countEl) return;
                
                const count = players.filter(p => p.connected).length;
                countEl.textContent = count;
                
                container.innerHTML = '';
                players.forEach((player) => {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    if (player.id === hostId) {
                        div.classList.add('host');
                    }
                    
                    const status = player.connected ? 'ğŸŸ¢' : 'ğŸ”´';
                    const disconnectedText = player.connected ? '' : ' (åˆ‡æ–­ä¸­)';
                    div.textContent = `${status} ${player.name}${disconnectedText}`;
                    
                    if (!player.connected) {
                        div.style.opacity = '0.6';
                        div.style.fontStyle = 'italic';
                    }
                    
                    container.appendChild(div);
                });
            }
        }

        // SocketClient ã‚¯ãƒ©ã‚¹
        class SocketClient {
            constructor(game) {
                this.game = game;
                this.socket = null;
                this.initializeSocket();
            }

            initializeSocket() {
                try {
                    this.socket = io({
                        transports: ['websocket', 'polling'],
                        timeout: 5000
                    });
                    
                    this.setupEventListeners();
                } catch (error) {
                    console.error('SocketåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setupEventListeners() {
                if (!this.socket) return;

                this.socket.on('connect', () => {
                    this.game.mySocketId = this.socket.id;
                    UIManager.showConnectionStatus('connected');
                    console.log('Socket.ioæ¥ç¶šæˆåŠŸ');
                });

                this.socket.on('disconnect', (reason) => {
                    UIManager.showConnectionStatus('disconnected');
                    console.log('Socket.ioåˆ‡æ–­:', reason);
                });

                this.socket.on('connect_error', (error) => {
                    console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                    UIManager.showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');
                });

                this.socket.on('roomCreated', (data) => {
                    this.game.onRoomCreated(data);
                });

                this.socket.on('joinSuccess', (data) => {
                    this.game.onJoinSuccess(data);
                });

                this.socket.on('gameUpdate', (gameData) => {
                    this.game.gameData = gameData;
                    this.game.updateUI();
                });

                this.socket.on('error', (error) => {
                    UIManager.showError(error.message);
                });
            }

            emit(event, data) {
                if (this.socket && this.socket.connected) {
                    this.socket.emit(event, data);
                } else {
                    console.warn('Socket not connected');
                    UIManager.showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }

            createRoom(playerName, hasPassword, password) {
                this.emit('createRoom', { playerName, hasPassword, password });
            }

            joinRoom(roomId, playerName, password) {
                this.emit('joinRoom', { roomId, playerName, password });
            }

            leaveRoom() {
                this.emit('leaveRoom');
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹
        class TreasureTempleGame {
            constructor() {
                this.socket = null;
                this.roomId = null;
                this.gameData = null;
                this.isHost = false;
                this.mySocketId = null;
                this.myName = null;
                this.isSpectator = false;
                
                this.socketClient = new SocketClient(this);
                this.initializeEventListeners();
                
                console.log('TreasureTempleGameåˆæœŸåŒ–å®Œäº†');
            }

            initializeEventListeners() {
                console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–é–‹å§‹');

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                safeAddEventListener('use-password', 'change', (e) => {
                    const passwordGroup = safeGetElement('password-group');
                    if (passwordGroup) {
                        passwordGroup.style.display = e.target.checked ? 'block' : 'none';
                    }
                });

                // ãƒ«ãƒ¼ãƒ æ“ä½œ
                safeAddEventListener('create-room', 'click', () => this.createRoom());
                safeAddEventListener('join-room', 'click', () => this.joinRoom());
                safeAddEventListener('rejoin-room', 'click', () => this.rejoinRoom());
                safeAddEventListener('spectate-room', 'click', () => this.spectateRoom());
                safeAddEventListener('leave-room', 'click', () => this.leaveRoom());
                safeAddEventListener('temp-leave-room', 'click', () => this.tempLeaveRoom());
                safeAddEventListener('cancel-temp-leave', 'click', () => this.cancelTempLeave());
                safeAddEventListener('game-leave-room', 'click', () => this.showTempLeaveDialog());
                safeAddEventListener('start-game', 'click', () => this.startGame());
                safeAddEventListener('return-to-lobby', 'click', () => this.returnToLobby());
                safeAddEventListener('return-to-lobby-victory', 'click', () => this.returnToLobby());

                console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–å®Œäº†');
            }

            createRoom() {
                console.log('ãƒ«ãƒ¼ãƒ ä½œæˆé–‹å§‹');
                
                const nameInput = safeGetElement('player-name-create');
                const playerName = nameInput ? (nameInput.value.trim() || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${Math.floor(Math.random() * 1000)}`) : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${Math.floor(Math.random() * 1000)}`;
                const hasPassword = safeGetElement('use-password')?.checked || false;
                const password = hasPassword ? (safeGetElement('room-password')?.value || '') : '';
                
                this.myName = playerName;
                UIManager.showPlayerName(this.myName);
                
                this.socketClient.createRoom(playerName, hasPassword, password);
                UIManager.showError('ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆä¸­...', 'warning');
            }

            joinRoom() {
                console.log('ãƒ«ãƒ¼ãƒ å‚åŠ é–‹å§‹');
                
                const nameInput = safeGetElement('player-name-join');
                const roomInput = safeGetElement('room-id-input');
                const passwordInput = safeGetElement('join-password');
                
                const playerName = nameInput ? (nameInput.value.trim() || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${Math.floor(Math.random() * 1000)}`) : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${Math.floor(Math.random() * 1000)}`;
                const roomId = roomInput ? roomInput.value.trim().toUpperCase() : '';
                const password = passwordInput ? passwordInput.value : '';

                if (!roomId) {
                    UIManager.showError('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                this.myName = playerName;
                UIManager.showPlayerName(this.myName);
                this.roomId = roomId;
                
                this.socketClient.joinRoom(roomId, playerName, password);
                UIManager.showError('ãƒ«ãƒ¼ãƒ ã«å‚åŠ ä¸­...', 'warning');
            }

            rejoinRoom() {
                console.log('å†å…¥å ´å‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰');
                UIManager.showError('å†å…¥å ´æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'warning');
            }

            spectateRoom() {
                console.log('è¦³æˆ¦å‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰');
                UIManager.showError('è¦³æˆ¦æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'warning');
            }

            tempLeaveRoom() {
                console.log('ä¸€æ™‚é€€å‡ºå‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰');
                this.leaveRoom();
            }

            cancelTempLeave() {
                const tempLeaveSection = safeGetElement('temp-leave-section');
                if (tempLeaveSection) {
                    tempLeaveSection.style.display = 'none';
                }
                if (this.gameData && this.gameData.gameState === 'playing') {
                    UIManager.showScreen('game-board');
                }
            }

            showTempLeaveDialog() {
                if (this.gameData && this.gameData.gameState === 'playing') {
                    const tempLeaveSection = safeGetElement('temp-leave-section');
                    if (tempLeaveSection) {
                        tempLeaveSection.style.display = 'block';
                    }
                    UIManager.showScreen('room-info');
                    const roomIdDisplay = safeGetElement('room-id-display');
                    if (roomIdDisplay && this.roomId) {
                        roomIdDisplay.textContent = this.roomId;
                    }
                } else {
                    this.leaveRoom();
                }
            }

            startGame() {
                if (this.isSpectator) {
                    UIManager.showError('è¦³æˆ¦è€…ã¯ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã›ã‚“');
                    return;
                }
                
                // ç°¡æ˜“ç‰ˆã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†
                UIManager.showError('ã‚²ãƒ¼ãƒ é–‹å§‹æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'warning');
            }

            leaveRoom() {
                this.socketClient.leaveRoom();
                this.roomId = null;
                this.gameData = null;
                this.isHost = false;
                this.isSpectator = false;
                
                UIManager.showScreen('lobby');
                UIManager.showError('ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸ', 'success');
            }

            returnToLobby() {
                this.leaveRoom();
            }

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
            onRoomCreated(data) {
                console.log('ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ:', data);
                this.roomId = data.roomId;
                this.gameData = data.gameData;
                this.isHost = true;
                
                this.showRoomInfo();
                UIManager.showError(`ãƒ«ãƒ¼ãƒ  ${data.roomId} ã‚’ä½œæˆã—ã¾ã—ãŸï¼`, 'success');
            }

            onJoinSuccess(data) {
                console.log('ãƒ«ãƒ¼ãƒ å‚åŠ æˆåŠŸ:', data);
                this.roomId = data.roomId;
                this.gameData = data.gameData;
                this.isHost = data.playerInfo ? data.playerInfo.isHost : false;
                
                this.updateUI();
                UIManager.showError(`ãƒ«ãƒ¼ãƒ  ${data.roomId} ã«å‚åŠ ã—ã¾ã—ãŸï¼`, 'success');
            }

            showRoomInfo() {
                UIManager.showScreen('room-info');
                const roomIdDisplay = safeGetElement('room-id-display');
                if (roomIdDisplay && this.roomId) {
                    roomIdDisplay.textContent = this.roomId;
                }
            }

            updateUI() {
                if (!this.gameData) return;

                safeSetText('treasure-goal', this.gameData.treasureGoal || 7);

                if (this.gameData.players) {
                    UIManager.updatePlayersList(this.gameData.players, this.gameData.host);
                }

                if (this.gameData.gameState === 'waiting') {
                    this.updateLobbyUI();
                } else if (this.gameData.gameState === 'playing') {
                    this.updateGameUI();
                } else if (this.gameData.gameState === 'finished') {
                    this.showVictoryScreen();
                }
            }

            updateLobbyUI() {
                UIManager.showScreen('room-info');
                
                const startButton = safeGetElement('start-game');
                const tempLeaveSection = safeGetElement('temp-leave-section');
                
                if (this.gameData && this.gameData.players) {
                    const count = this.gameData.players.filter(p => p.connected).length;
                    if (this.isHost && count >= 3 && startButton) {
                        startButton.style.display = 'block';
                    } else if (startButton) {
                        startButton.style.display = 'none';
                    }
                }
                
                if (tempLeaveSection) {
                    tempLeaveSection.style.display = 'none';
                }
            }

            updateGameUI() {
                UIManager.showScreen('game-board');
                
                if (this.gameData) {
                    safeSetText('current-round', this.gameData.currentRound || 1);
                    safeSetText('treasure-found', this.gameData.treasureFound || 0);
                    safeSetText('treasure-goal', this.gameData.treasureGoal || 7);
                    safeSetText('trap-triggered', this.gameData.trapTriggered || 0);
                    safeSetText('trap-goal', this.gameData.trapGoal || 2);

                    const keyHolder = this.gameData.players ? this.gameData.players.find(p => p.id === this.gameData.keyHolderId) : null;
                    safeSetText('key-holder-name', keyHolder ? keyHolder.name : 'ä¸æ˜');
                    
                    const isMyTurn = this.gameData.keyHolderId === this.mySocketId;
                    safeSetText('turn-message', isMyTurn ? 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼' : 'å¾…æ©Ÿä¸­...');
                }
            }

            showVictoryScreen() {
                UIManager.showScreen('victory-screen');
                
                if (this.gameData) {
                    const title = safeGetElement('victory-title');
                    const message = safeGetElement('victory-message');
                    
                    if (title && message) {
                        if (this.gameData.winningTeam === 'adventurer') {
                            title.textContent = 'â›ï¸ æ¢æ¤œå®¶ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼';
                            title.style.color = '#FFD700';
                        } else {
                            title.textContent = 'ğŸ· è±šç”·ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼';
                            title.style.color = '#DC143C';
                        }
                        
                        message.textContent = this.gameData.victoryMessage || 'ã‚²ãƒ¼ãƒ çµ‚äº†ï¼';
                    }
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.UIManager = UIManager;
        window.SocketClient = SocketClient;
        window.TreasureTempleGame = TreasureTempleGame;

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            // å¿…é ˆè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const requiredElements = ['lobby', 'room-info', 'game-board', 'error-message'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            
            if (missingElements.length > 0) {
                console.error('å¿…é ˆè¦ç´ ãŒä¸è¶³:', missingElements);
                alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚\nä¸è¶³è¦ç´ : ' + missingElements.join(', '));
                return;
            }
            
            console.log('å¿…é ˆè¦ç´ ç¢ºèªå®Œäº†');
            
            // Socket.io ã®å­˜åœ¨ç¢ºèª
            if (typeof io === 'undefined') {
                console.error('Socket.io ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                UIManager.showError('Socket.io ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }
            
            console.log('Socket.io ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†');
            
            try {
                // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const game = new TreasureTempleGame();
                window.game = game;
                
                console.log('âœ… ã‚²ãƒ¼ãƒ åˆæœŸåŒ–æˆåŠŸï¼');
                UIManager.showError('ã‚²ãƒ¼ãƒ æº–å‚™å®Œäº†ï¼', 'success');
                
            } catch (error) {
                console.error('ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                UIManager.showError('ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            console.error('JavaScript ã‚¨ãƒ©ãƒ¼:', event.error);
            UIManager.showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise ã‚¨ãƒ©ãƒ¼:', event.reason);
            UIManager.showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });

        console.log('JavaScript èª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>
